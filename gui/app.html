<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ-Gen AI</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Connection Warning -->
        <div v-if="serverStatus === 'offline'" class="connection-banner">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>Warning: Backend server or Ollama seems unreachable. Please ensure they are running.</span>
            <button @click="checkHealth" class="retry-btn">Retry</button>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-brain"></i>
                <h2>MCQ-Gen AI</h2>
            </div>
            
            <div class="sidebar-content">
                <div class="control-group">
                    <label><i class="fa-solid fa-align-left"></i> Context / Topic</label>
                    <textarea v-model="context" placeholder="Paste your notes or type a topic (e.g., 'Quantum Physics')..."></textarea>
                </div>

                <div class="control-group">
                    <label><i class="fa-solid fa-layer-group"></i> Difficulty</label>
                    <div class="select-wrapper">
                        <select v-model="difficulty">
                            <option>Easy</option>
                            <option>Medium</option>
                            <option>Hard</option>
                        </select>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="primary-btn" @click="startSession" :disabled="isLoading">
                    <span v-if="!isLoading"><i class="fa-solid fa-play"></i> Start Quiz</span>
                    <span v-else><i class="fa-solid fa-spinner fa-spin"></i> Preparing...</span>
                </button>
                <button class="reset-btn" @click="resetChat">
                    <i class="fa-solid fa-rotate-right"></i> Reset
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h3><i class="fa-solid fa-comments"></i> Interactive Quiz Session</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="status-badge" v-if="difficulty">{{ difficulty }} Mode</span>
                    <button @click="toggleTheme" class="theme-toggle" :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
                        <i :class="['fa-solid', isDarkMode ? 'fa-sun' : 'fa-moon']"></i>
                    </button>
                </div>
            </div>

            <div class="messages" ref="msgContainer">
                <div v-if="messages.length === 0" class="empty-state">
                    <i class="fa-solid fa-lightbulb"></i>
                    <p>Enter a topic on the left and click "Start Quiz" to begin!</p>
                </div>

                <div v-for="(msg, index) in messages" :key="index" :class="['message-wrapper', msg.role]">
                    <div class="avatar">
                        <i v-if="msg.role === 'assistant'" class="fa-solid fa-robot"></i>
                        <i v-else class="fa-solid fa-user"></i>
                    </div>
                    <div class="message-content">
                        {{ msg.content }}
                    </div>
                </div>
                
                <div v-if="isLoading" class="message-wrapper assistant">
                    <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                    <div class="message-content loading-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" 
                           v-model="userInput" 
                           @keyup.enter="sendMessage" 
                           placeholder="Type your answer (A, B, C, D)..."
                           :disabled="isLoading || messages.length === 0"
                           ref="inputField">
                    <button class="send-btn" @click="sendMessage" :disabled="isLoading || messages.length === 0">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    context: '',
                    difficulty: 'Easy',
                    userInput: '',
                    messages: [], // Array of {role: 'user'|'assistant', content: string}
                    isLoading: false,
                    isDarkMode: false,
                    serverStatus: 'checking' // 'online', 'offline', 'checking'
                }
            },
            mounted() {
                // Check local storage or system preference on load
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    this.isDarkMode = true;
                    document.body.classList.add('dark-mode');
                }
                
                this.checkHealth();
            },
            methods: {
                async checkHealth() {
                    try {
                        const res = await fetch('/api/health');
                        if (res.ok) {
                            this.serverStatus = 'online';
                        } else {
                            this.serverStatus = 'offline';
                        }
                    } catch (e) {
                        this.serverStatus = 'offline';
                    }
                },

                toggleTheme() {
                    this.isDarkMode = !this.isDarkMode;
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
                },

                async startSession() {
                    if (!this.context.trim()) {
                        alert("Please provide a topic or text first.");
                        return;
                    }
                    
                    if (this.messages.length > 0) {
                        if (!confirm("Start a new session? Current progress will be lost.")) {
                            return;
                        }
                    }
                    
                    this.messages = []; // Clear chat
                    const prompt = `Hi! I want to generate ${this.difficulty} MCQs based on this content:\n\n${this.context}`;
                    
                    // Add internal system instruction (hidden from UI, but sent to API)
                    // We simulate the user "sending" the prompt
                    this.addMessage('user', prompt);
                    
                    await this.fetchResponse();
                },

                async sendMessage() {
                    if (!this.userInput.trim()) return;

                    this.addMessage('user', this.userInput);
                    this.userInput = '';
                    await this.fetchResponse();
                },

                addMessage(role, content) {
                    this.messages.push({ role, content });
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                },

                async fetchResponse() {
                    this.isLoading = true;
                    try {
                        const payload = {
                            messages: this.messages
                        };

                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();
                        this.addMessage('assistant', data.content);
                    } catch (error) {
                        console.error(error);
                        this.addMessage('assistant', "Error: Could not connect to the server.");
                    } finally {
                        this.isLoading = false;
                    }
                },

                resetChat() {
                    this.messages = [];
                    this.context = '';
                    this.userInput = '';
                },

                scrollToBottom() {
                    const container = this.$refs.msgContainer;
                    container.scrollTop = container.scrollHeight;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
